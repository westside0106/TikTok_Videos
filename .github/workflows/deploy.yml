name: Deploy to Server

on:
  # Manuell auslösen – ein Klick in der GitHub-App reicht
  workflow_dispatch:

jobs:
  deploy:
    name: SSH Deploy & Setup
    runs-on: ubuntu-latest

    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 46.225.231.151
          username: root
          password: ${{ secrets.SSH_PASSWORD }}
          port: 22
          script_stop: true
          script: |
            set -e

            APP_DIR="/opt/tiktok-bot"
            REPO="https://github.com/westside0106/TikTok_Videos.git"

            echo "=== System Update ==="
            apt-get update -qq
            apt-get install -y -qq ffmpeg git python3 python3-pip python3-venv

            echo "=== Clone / Update Repo ==="
            if [ -d "$APP_DIR/.git" ]; then
              git -C "$APP_DIR" pull origin main
            else
              git clone "$REPO" "$APP_DIR"
            fi

            echo "=== Python Virtual Environment ==="
            python3 -m venv "$APP_DIR/venv"
            "$APP_DIR/venv/bin/pip" install --upgrade pip -q
            "$APP_DIR/venv/bin/pip" install -r "$APP_DIR/requirements.txt" -q

            echo "=== Configure .env ==="
            cat > "$APP_DIR/.env" <<'ENVEOF'
TELEGRAM_BOT_TOKEN=${{ secrets.BOT_TOKEN }}
WHISPER_MODEL=base
MAX_CLIPS_PER_VIDEO=3
CLIP_MIN_DURATION=15
CLIP_MAX_DURATION=60
OUTPUT_DIR=./output
TEMP_DIR=./tmp
MAX_VIDEO_DURATION=3600
MAX_FILE_SIZE_MB=500
AUDIO_ENERGY_WEIGHT=0.4
KEYWORD_WEIGHT=0.3
SCENE_CHANGE_WEIGHT=0.3
LOG_LEVEL=INFO
WHISPER_BEAM_SIZE=5
ENVEOF
            chmod 600 "$APP_DIR/.env"

            mkdir -p "$APP_DIR/output" "$APP_DIR/tmp"

            echo "=== Install systemd Service ==="
            cat > /etc/systemd/system/tiktok-bot.service <<SVCEOF
[Unit]
Description=TikTok Video Clip Generator Bot
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=root
WorkingDirectory=${APP_DIR}
EnvironmentFile=${APP_DIR}/.env
ExecStart=${APP_DIR}/venv/bin/python ${APP_DIR}/bot.py
Restart=on-failure
RestartSec=10
StandardOutput=journal
StandardError=journal
SyslogIdentifier=tiktok-bot

[Install]
WantedBy=multi-user.target
SVCEOF

            systemctl daemon-reload
            systemctl enable tiktok-bot
            systemctl restart tiktok-bot
            sleep 3
            systemctl status tiktok-bot --no-pager -l

            echo ""
            echo "Bot erfolgreich deployed und gestartet!"
